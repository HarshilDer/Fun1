<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Grocify Pro V3</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --magenta: #ff00ff; --lime: #39ff14; --dark-bg: #0a0a12; }

        body { transition: 0.3s; background-color: #f8f9fa; min-height: 100vh; }

        /* THEMES */
        [data-theme="dark"] { background-color: #1a1a1a; color: #eee; }
        [data-theme="dark"] .card { background-color: #2d2d2d; color: white; border: none; }

        [data-theme="funky"] { background-color: var(--dark-bg); color: var(--neon); font-family: 'Courier New', monospace; }
        [data-theme="funky"] .card { background: #161625; border: 2px solid var(--magenta); box-shadow: 0 0 15px rgba(255, 0, 255, 0.2); color: white; }
        [data-theme="funky"] .btn-primary { background: var(--magenta); border: none; box-shadow: 0 0 10px var(--magenta); color: white; }
        [data-theme="funky"] .btn-success { background: var(--lime); color: black; border: none; font-weight: bold; }
        [data-theme="funky"] h1, [data-theme="funky"] h5 { color: var(--neon); text-shadow: 0 0 8px var(--neon); }

        /* ANIMATIONS */
        .fade-in { animation: fadeInUp 0.6s ease forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { border-radius: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .debt-line { padding: 8px; border-left: 4px solid var(--magenta); background: rgba(255, 0, 255, 0.05); margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body class="p-3 p-md-5">

<div class="container">
    <header class="d-flex flex-wrap justify-content-between align-items-center mb-5 fade-in">
        <h1 class="fw-bold m-0">ü•¶ GROCIFY <span class="fs-6 opacity-50">PRO v3</span></h1>

        <div class="d-flex gap-2 align-items-center">
            <select id="currencySelect" class="form-select form-select-sm w-auto" onchange="updateCurrency()">
                <option value="$">$ USD</option>
                <option value="‚Çπ">‚Çπ INR</option>
                <option value="‚Ç¨">‚Ç¨ EUR</option>
                <option value="¬£">¬£ GBP</option>
            </select>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" onclick="setTheme('light')">Light</button>
                <button class="btn btn-sm btn-dark" onclick="setTheme('dark')">Dark</button>
                <button class="btn btn-sm btn-info text-white" onclick="setTheme('funky')">Funky</button>
            </div>
        </div>
    </header>

    <div class="row g-4">
        <div class="col-lg-4 fade-in" style="animation-delay: 0.1s;">
            <div id="settlement-card" class="card p-4 shadow-sm mb-4">
                <h5 class="mb-3 fw-bold">Financial Health</h5>
                <div class="chart-container">{{ chart_html|safe }}</div>

                <div class="mt-3">
                    {% for name, bal in balances.items() %}
                    <div class="d-flex justify-content-between py-2 border-bottom border-secondary border-opacity-10">
                        <span>{{ name }}</span>
                        <span class="fw-bold curr-val {{ 'text-success' if bal >= 0 else 'text-danger' }}" data-base="{{ bal }}">
                            {{ bal }}
                        </span>
                    </div>
                    {% endfor %}
                </div>

                <h6 class="mt-4 mb-2 small fw-bold text-uppercase opacity-75">Who Pays Whom:</h6>
                <div id="debt-simplification">
                    {% for d in debts %}
                    <div class="debt-line">
                        <strong>{{ d.from }}</strong> pays <strong>{{ d.to }}</strong> <span class="curr-val" data-base="{{ d.amount }}">{{ d.amount }}</span>
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-4 d-grid gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="capture()">üì∏ Share Screenshot</button>
                    <a href="/export" class="btn btn-sm btn-outline-success">üì• Download CSV</a>
                    <form action="/settle_up" method="POST" onsubmit="return confirm('WARNING: This will permanently delete ALL grocery records. Balances will reset to 0. Proceed?')">
                        <button class="btn btn-sm btn-danger w-100 mt-2">üßπ Settle Up (Reset All)</button>
                    </form>
                </div>
            </div>

            <div class="card p-3 shadow-sm">
                <form action="/add_member" method="POST" class="input-group">
                    <input type="text" name="member_name" class="form-control" placeholder="New Roommate" required>
                    <button class="btn btn-success">Add</button>
                </form>
            </div>
        </div>

        <div class="col-lg-8 fade-in" style="animation-delay: 0.2s;">
            <div class="card p-4 shadow-sm mb-4">
                <h5 class="mb-3 fw-bold">Add Transaction</h5>
                <form action="/add_item" method="POST" class="row g-3">
                    <div class="col-md-6"><input type="text" name="name" class="form-control" placeholder="Item (e.g. Milk)" required></div>
                    <div class="col-md-3"><input type="number" step="0.01" name="price" class="form-control" placeholder="Price" required></div>
                    <div class="col-md-3">
                        <select name="category" class="form-select">
                            {% for cat in categories %}<option value="{{cat}}">{{cat}}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="small opacity-75">Paid By:</label>
                        <select name="payer_name" class="form-select">
                            {% for m in members %}<option value="{{m.name}}">{{m.name}}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="small opacity-75">Shared With (Ctrl+Click):</label>
                        <select name="assignees" class="form-select" multiple required>
                            {% for m in members %}<option value="{{m.name}}" selected>{{m.name}}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-12"><button class="btn btn-primary w-100">Log Expense</button></div>
                </form>
            </div>

            <div class="card shadow-sm overflow-hidden">
                <div class="p-3 bg-light border-bottom d-flex align-items-center">
                    <input type="text" id="searchInput" onkeyup="filterTable()" class="form-control form-control-sm" placeholder="üîç Search items, people, or categories...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="mainTable">
                        <thead class="table-dark">
                            <tr><th>Item</th><th>Payer</th><th>Price</th><th class="text-end">Actions</th></tr>
                        </thead>
                        <tbody>
                            {% for i in items %}
                            <tr>
                                <td><strong>{{i.name}}</strong><br><small class="badge bg-secondary">{{i.category}}</small></td>
                                <td>{{i.payer_name}}</td>
                                <td class="fw-bold curr-val" data-base="{{i.price}}">{{i.price}}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-warning" onclick="openEdit('{{i.id}}')">‚úèÔ∏è</button>
                                    <a href="/delete_item/{{i.id}}" class="btn btn-sm btn-outline-danger">üóë</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/edit_item" method="POST" class="modal-content card p-4">
            <h5 class="mb-3 fw-bold">Update Record</h5>
            <input type="hidden" name="item_id" id="edit_id">
            <div class="mb-2"><input type="text" name="name" id="edit_name" class="form-control" placeholder="Item Name"></div>
            <div class="mb-2"><input type="number" step="0.01" name="price" id="edit_price" class="form-control" placeholder="Price"></div>
            <div class="mb-2">
                <select name="category" id="edit_cat" class="form-select">
                    {% for cat in categories %}<option value="{{cat}}">{{cat}}</option>{% endfor %}
                </select>
            </div>
            <div class="mb-2">
                <label class="small">Payer</label>
                <select name="payer_name" id="edit_payer" class="form-select">
                    {% for m in members %}<option value="{{m.name}}">{{m.name}}</option>{% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="small">Split With</label>
                <select name="assignees" id="edit_assignees" class="form-select" multiple>
                    {% for m in members %}<option value="{{m.name}}">{{m.name}}</option>{% endfor %}
                </select>
            </div>
            <button class="btn btn-success w-100">Save Changes</button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // THEME ENGINE
    function setTheme(t) {
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('grocify-theme', t);
    }
    setTheme(localStorage.getItem('grocify-theme') || 'light');

    // CURRENCY ENGINE
    function updateCurrency() {
        const symbol = document.getElementById('currencySelect').value;
        localStorage.setItem('grocify-curr', symbol);
        document.querySelectorAll('.curr-val').forEach(el => {
            const val = parseFloat(el.getAttribute('data-base'));
            el.innerText = symbol + Math.abs(val).toFixed(2) + (val < 0 ? ' (Owed)' : '');
        });
    }
    window.onload = updateCurrency;

    // SEARCH FILTER
    function filterTable() {
        let input = document.getElementById("searchInput").value.toUpperCase();
        let trs = document.getElementById("mainTable").getElementsByTagName("tr");
        for (let i = 1; i < trs.length; i++) {
            trs[i].style.display = trs[i].innerText.toUpperCase().includes(input) ? "" : "none";
        }
    }

    // EDIT MODAL (API FETCH)
    async function openEdit(id) {
        const res = await fetch(`/get_item/${id}`);
        const data = await res.json();
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_name').value = data.name;
        document.getElementById('edit_price').value = data.price;
        document.getElementById('edit_cat').value = data.category;
        document.getElementById('edit_payer').value = data.payer;
        const sel = document.getElementById('edit_assignees');
        Array.from(sel.options).forEach(opt => opt.selected = data.assignees.includes(opt.value));
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    // SCREENSHOT CAPTURE
    function capture() {
        html2canvas(document.querySelector("#settlement-card")).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Grocify_Settlement.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>